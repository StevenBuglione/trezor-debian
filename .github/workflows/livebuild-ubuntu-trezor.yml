name: Live-Build Ubuntu + Trezor Suite ISO

on:
  workflow_dispatch:
    inputs:
      ubuntu_codename:
        description: "Ubuntu codename: jammy (22.04 LTS) or noble (24.04 LTS)"
        default: "jammy"
        required: true
      disable_network_by_default:
        description: "Disable NetworkManager by default in the live session"
        type: boolean
        default: false
  schedule:
    - cron: "0 9 1 * *"  # monthly, 09:00 UTC on the 1st

permissions:
  contents: write

jobs:
  live_build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    defaults:
      run:
        shell: bash  # ensure bash for heredocs and [[ ]]

    env:
      # Mirrors
      UBUNTU_MIRROR: "http://archive.ubuntu.com/ubuntu/"
      UBUNTU_SECURITY: "http://security.ubuntu.com/ubuntu/"
      # Keys
      TREZOR_SIGNING_KEYID: "0x86E0D76E6D53CAC6"
      # Output name
      TAILORED_ISO_NAME: "ubuntu-live-trezor.iso"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Runner info
        run: |
          set -euxo pipefail
          uname -a || true
          lsb_release -a || true
          df -h || true
          free -h || true
          echo "Inputs: codename=${{ github.event.inputs.ubuntu_codename }}, disable_net=${{ github.event.inputs.disable_network_by_default }}"

      - name: Install build tools
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            live-build debootstrap cdebootstrap \
            xorriso squashfs-tools genisoimage \
            dosfstools syslinux-utils isolinux \
            gpg wget curl rsync ca-certificates \
            ubuntu-keyring
          live-build --version || true

      - name: Resolve variables
        id: vars
        run: |
          set -euxo pipefail
          CODENAME="${{ github.event.inputs.ubuntu_codename || 'jammy' }}"
          DISABLE_NET="${{ github.event.inputs.disable_network_by_default == 'true' && 'true' || 'false' }}"
          echo "CODENAME=$CODENAME" >> "$GITHUB_OUTPUT"
          echo "DISABLE_NET=$DISABLE_NET" >> "$GITHUB_OUTPUT"
          echo "VOL=UBUNTU_${CODENAME}_TREZOR" >> "$GITHUB_OUTPUT"

      - name: Prepare live-build config (heredocs fixed)
        run: |
          set -euxo pipefail

          sudo lb clean || true
          rm -rf config build-cache logs || true
          mkdir -p config/includes.chroot/opt/trezor
          mkdir -p config/includes.chroot/usr/share/applications
          mkdir -p config/includes.chroot/etc/udev/rules.d
          mkdir -p config/package-lists
          mkdir -p config/hooks/normal
          mkdir -p logs

          # package list (make sure AppImage can run)
          cat > config/package-lists/base.list.chroot <<'EOF'
          ubuntu-standard
          casper
          linux-generic
          network-manager
          xorg
          xserver-xorg
          libfuse2
          xdg-utils
          gvfs
          udev
          EOF

          # udev rules for Trezor (permissive for ephemeral live session)
          cat > config/includes.chroot/etc/udev/rules.d/51-trezor.rules <<'EOF'
          SUBSYSTEM=="hidraw", ATTRS{idVendor}=="534c", MODE="0666"
          SUBSYSTEM=="usb",   ATTR{idVendor}=="534c", MODE="0666"
          EOF

          # Desktop launcher
          cat > config/includes.chroot/usr/share/applications/trezor-suite.desktop <<'EOF'
          [Desktop Entry]
          Name=Trezor Suite
          Exec=/opt/trezor/trezor-suite.AppImage
          Icon=utilities-terminal
          Type=Application
          Categories=Finance;Utility;
          Terminal=false
          EOF

          # Optional: disable networking by default
          if [[ "${{ steps.vars.outputs.DISABLE_NET }}" == "true" ]]; then
            mkdir -p config/includes.chroot/etc/NetworkManager/conf.d
            cat > config/includes.chroot/etc/NetworkManager/conf.d/00-offline.conf <<'EOF'
            [main]
            networking=false
            EOF
          fi

          # Hook: refresh initramfs
          cat > config/hooks/normal/99-update-initramfs.chroot <<'EOF'
          #!/bin/sh
          set -eux
          update-initramfs -u
          EOF
          chmod +x config/hooks/normal/99-update-initramfs.chroot

      - name: Fetch & verify latest Trezor Suite
        run: |
          set -euxo pipefail
          retry() { for i in {1..3}; do "$@" && return 0 || sleep 2; done; return 1; }

          mkdir -p build-cache
          pushd build-cache
          retry curl -LsS "https://suite.trezor.io/web/static/media/trezor-suite-latest.AppImage" -o trezor-suite.AppImage
          retry curl -LsS "https://suite.trezor.io/static/trezor-suite-latest.AppImage.asc" -o trezor-suite.AppImage.asc

          # import trezor key & verify
          retry gpg --keyserver hkps://keys.openpgp.org --recv-keys "${TREZOR_SIGNING_KEYID}" || \
          retry gpg --keyserver hkps://keyserver.ubuntu.com --recv-keys "${TREZOR_SIGNING_KEYID}"
          gpg --batch --verify trezor-suite.AppImage.asc trezor-suite.AppImage

          chmod +x trezor-suite.AppImage
          popd

          cp build-cache/trezor-suite.AppImage config/includes.chroot/opt/trezor/trezor-suite.AppImage

      - name: Configure live-build
        run: |
          set -euxo pipefail
          CODENAME="${{ steps.vars.outputs.CODENAME }}"
          sudo lb clean || true
          lb config \
            --mode ubuntu \
            --distribution "${CODENAME}" \
            --binary-images iso-hybrid \
            --archive-areas "main restricted universe multiverse" \
            --parent-mirror-bootstrap "${UBUNTU_MIRROR}" \
            --parent-mirror-chroot "${UBUNTU_MIRROR}" \
            --parent-mirror-chroot-security "${UBUNTU_SECURITY}" \
            --parent-mirror-binary "${UBUNTU_MIRROR}" \
            --parent-mirror-binary-security "${UBUNTU_SECURITY}" \
            --apt-recommends true \
            --debian-installer false \
            --bootappend-live "boot=casper quiet splash" \
            --linux-flavours "generic" \
            --iso-application "Ubuntu Live (Trezor Suite)" \
            --iso-volume "${{ steps.vars.outputs.VOL }}" \
            --checksums "sha256"

      - name: Build ISO (verbose)
        run: |
          set -euxo pipefail
          (time sudo lb build) 2>&1 | tee logs/live-build.log
          ls -lh *.iso || { echo "No ISO produced"; exit 3; }
          LB_OUT=$(ls -1 *.iso | head -n1)
          echo "LB_OUT=${LB_OUT}"
          cp "${LB_OUT}" "${TAILORED_ISO_NAME}"
          sha256sum "${TAILORED_ISO_NAME}" | tee ubuntu-live-trezor.iso.sha256

      - name: Collect and upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: livebuild-output
          path: |
            ${{ env.TAILORED_ISO_NAME }}
            ubuntu-live-trezor.iso.sha256
            logs/
          retention-days: 21

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: livebuild-${{ steps.vars.outputs.CODENAME }}-${{ github.run_id }}
          name: "Live-Build Ubuntu + Trezor Suite (${{ steps.vars.outputs.CODENAME }})"
          files: |
            ${{ env.TAILORED_ISO_NAME }}
            ubuntu-live-trezor.iso.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
