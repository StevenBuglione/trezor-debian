%include __KSDIR__/fedora-live-workstation.ks

%packages
trezor-common
fuse-libs
curl
jq
sudo
ca-certificates
%end

# Copy pre-fetched bits from the workspace into the image and always create a launcher.
# No network needed during compose.
%post --nochroot --log=/root/trezor-post.log
set -euo pipefail

LIVE_ROOT="/mnt/sysimage"
SRC="/workspace/scripts/fedora-live/vendor"

# Ensure dirs
install -d -m0755 "${LIVE_ROOT}/opt/trezor"
install -d -m0755 "${LIVE_ROOT}/usr/share/applications"
install -d -m0755 "${LIVE_ROOT}/usr/local/bin"

# If host prefetch succeeded, copy artifacts in; otherwise, the launcher will self-fetch on first run.
if [ -f "${SRC}/trezor-suite.AppImage" ]; then
  install -m0755 "${SRC}/trezor-suite.AppImage" "${LIVE_ROOT}/opt/trezor/trezor-suite.AppImage"
fi
if [ -f "${SRC}/trezor-suite.AppImage.asc" ]; then
  install -m0644 "${SRC}/trezor-suite.AppImage.asc" "${LIVE_ROOT}/opt/trezor/trezor-suite.AppImage.asc"
fi
if [ -f "${SRC}/trezor.asc" ]; then
  install -m0644 "${SRC}/trezor.asc" "${LIVE_ROOT}/opt/trezor/trezor.asc"
fi

# First-run helper: if AppImage is missing, fetch latest for the correct arch at launch.
cat > "${LIVE_ROOT}/usr/local/bin/trezor-suite" <<'EOS'
#!/usr/bin/env bash
set -euo pipefail

APP="/opt/trezor/trezor-suite.AppImage"

if [ ! -x "$APP" ]; then
  ARCH="$(uname -m)"
  case "$ARCH" in
    x86_64|amd64) RX='linux.*(x86_64|amd64|x64).*AppImage$' ;;
    aarch64|arm64) RX='linux.*(aarch64|arm64).*AppImage$' ;;
    armv7l|armv7|armhf) RX='linux.*(armv7|armhf).*AppImage$' ;;
    *) RX='AppImage$' ;;
  esac

  echo "Trezor Suite not found. Fetching latest AppImage for $ARCH â€¦"
  URL="$(curl -fsSL https://api.github.com/repos/trezor/trezor-suite/releases/latest \
        | jq -r --arg rx "$RX" '.assets[] | select(.name|test($rx)) | .browser_download_url' | head -n1)"
  if [ -z "$URL" ]; then
    echo "Could not determine latest AppImage URL for $ARCH." >&2
    exit 1
  fi

  TMP="$(mktemp)"
  curl -fsSL -L "$URL" -o "$TMP"
  sudo install -m0755 "$TMP" "$APP"
  rm -f "$TMP"
fi

exec "$APP" --no-sandbox "$@"
EOS
chmod +x "${LIVE_ROOT}/usr/local/bin/trezor-suite"

# Desktop launcher (always created)
cat > "${LIVE_ROOT}/usr/share/applications/trezor-suite.desktop" <<'EOF'
[Desktop Entry]
Name=Trezor Suite
Comment=Manage your Trezor hardware wallet
Exec=/usr/local/bin/trezor-suite
Terminal=false
Type=Application
Categories=Finance;Utility;
EOF
%end
