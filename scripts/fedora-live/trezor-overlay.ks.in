%include __KSDIR__/fedora-live-workstation.ks

%packages
trezor-common
fuse-libs
curl
jq
gnupg2
ca-certificates
%end

%post --log=/root/trezor-post.log
set -e

TREZOR_TAG="__TREZOR_TAG__"
TREZOR_KEY_URL="__TREZOR_KEY_URL__"
TREZOR_FPR="__TREZOR_FPR__"

mkdir -p /opt/trezor
cd /opt/trezor

curl -fsSL "$TREZOR_KEY_URL" -o trezor.asc
gpg2 --batch --import trezor.asc || gpg --batch --import trezor.asc

REL_API="https://api.github.com/repos/trezor/trezor-suite/releases/latest"
if [ -n "$TREZOR_TAG" ]; then
  REL_API="https://api.github.com/repos/trezor/trezor-suite/releases/tags/$TREZOR_TAG"
fi
curl -fsSL "$REL_API" -o /tmp/release.json

APP_URL=$(jq -r '.assets[] | select(.name|test("linux.*AppImage$")) | .browser_download_url' /tmp/release.json | head -n1)
ASC_URL=$(jq -r '.assets[] | select(.name|test("linux.*AppImage.asc$")) | .browser_download_url' /tmp/release.json | head -n1)
[ -n "$APP_URL" ] && [ -n "$ASC_URL" ] || { echo "Trezor Suite AppImage or .asc not found"; exit 20; }

curl -fsSLo trezor-suite.AppImage "$APP_URL"
curl -fsSLo trezor-suite.AppImage.asc "$ASC_URL"
chmod +x trezor-suite.AppImage

gpg2 --batch --status-fd=1 --verify trezor-suite.AppImage.asc trezor-suite.AppImage \
  1> /tmp/gpg-status.log 2> /tmp/gpg-stderr.log || true
SIG_FPR=$(awk "/^\\[GNUPG:\\] VALIDSIG /{print \$3; exit}" /tmp/gpg-status.log)
[ -n "$SIG_FPR" ] && [ "$SIG_FPR" = "$TREZOR_FPR" ] || { echo "Signature mismatch: $SIG_FPR"; exit 21; }

install -d /usr/share/applications
cat > /usr/share/applications/trezor-suite.desktop <<'EOF'
[Desktop Entry]
Name=Trezor Suite
Comment=Manage your Trezor hardware wallet
Exec=/opt/trezor/trezor-suite.AppImage --no-sandbox
Terminal=false
Type=Application
Categories=Finance;Utility;
EOF
%end
