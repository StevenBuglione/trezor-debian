# Base: official LXQt Live spin (pulls in live compose deps)
%include __KSDIR__/fedora-live-lxqt.ks

# Users / auth (use the spin's default liveuser for reliable boot/login)
rootpw --lock
firstboot --disable
selinux --enforcing
firewall --disabled

# Extra packages we need (and explicit removals)
%packages
# Needed for Trezor + helpers
trezor-common
fuse-libs
curl
jq
sudo
ca-certificates
rsync

# Wayland session + Xwayland shim
lxqt-wayland-session
lxqt-wayland-session-default-compositor-miriway
xorg-x11-server-Xwayland

# Theming + file manager for desktop/wallpaper
breeze-icon-theme
pcmanfm-qt
lxqt-config

# Purge browsers and obvious extras (keep this list lean)
-firefox
-chromium
-falkon
-lynx
-w3m
-transmission
-epiphany
-enki
-lximage-qt

-konqueror
-qupzilla
# (You can add more -pkgs here as you discover them)
%end

# Host-side post: copy artifacts, bundle scripts, set themes/wallpaper (no network)
%post --nochroot --log=/root/trezor-post.log
set -euo pipefail

LIVE_ROOT="/mnt/sysimage"
SRC_VENDOR="/workspace/scripts/fedora-live/vendor"
SRC_SCRIPTS="/workspace/trezor-scripts"
SRC_THEME="/workspace/themes/Arch-Colors"
SRC_IMG_DIR="/workspace/images"

# Ensure dirs
install -d -m0755 "${LIVE_ROOT}/opt/trezor" \
                   "${LIVE_ROOT}/opt/trezor-scripts" \
                   "${LIVE_ROOT}/usr/share/applications" \
                   "${LIVE_ROOT}/usr/local/bin" \
                   "${LIVE_ROOT}/etc/xdg/autostart" \
                   "${LIVE_ROOT}/etc/xdg/lxqt" \
                   "${LIVE_ROOT}/usr/share/backgrounds/trezor"

# If prefetched on the host, vendor them in (optional)
[ -f "${SRC_VENDOR}/trezor-suite.AppImage" ]     && install -m0755 "${SRC_VENDOR}/trezor-suite.AppImage"     "${LIVE_ROOT}/opt/trezor/trezor-suite.AppImage"     || true
[ -f "${SRC_VENDOR}/trezor-suite.AppImage.asc" ] && install -m0644 "${SRC_VENDOR}/trezor-suite.AppImage.asc" "${LIVE_ROOT}/opt/trezor/trezor-suite.AppImage.asc" || true
[ -f "${SRC_VENDOR}/trezor.asc" ]                && install -m0644 "${SRC_VENDOR}/trezor.asc"                "${LIVE_ROOT}/opt/trezor/trezor.asc"                || true

# Bundle YOUR repo scripts (exclude VCS junk), make executable
if [ -d "${SRC_SCRIPTS}" ]; then
  rsync -a --delete --exclude ".git" --exclude ".github" --exclude ".gitmodules" --exclude "*.md" \
    "${SRC_SCRIPTS}/" "${LIVE_ROOT}/opt/trezor-scripts/"
  find "${LIVE_ROOT}/opt/trezor-scripts" -type f -name "*.sh" -exec chmod 0755 {} \;
fi

# Desktop launcher for Trezor Suite (assumes AppImage is embedded by CI)
if [ -x "${LIVE_ROOT}/opt/trezor/trezor-suite.AppImage" ]; then
  cat > "${LIVE_ROOT}/usr/share/applications/trezor-suite.desktop" <<'EOF'
[Desktop Entry]
Name=Trezor Suite
Comment=Manage your Trezor hardware wallet
Exec=/opt/trezor/trezor-suite.AppImage --no-sandbox
Terminal=false
Type=Application
Categories=Finance;Utility;
EOF
fi

# ----------------------------
# Theming: Breeze Dark + Arch-Colors
# ----------------------------
# 1) Copy Arch-Colors LXQt theme from your repo if present
if [ -d "${SRC_THEME}" ]; then
  rsync -a "${SRC_THEME}/" "${LIVE_ROOT}/usr/share/lxqt/themes/Arch-Colors/"
fi

# 2) System-wide LXQt defaults
#    - Icon theme: Breeze Dark
#    - LXQt theme: Arch-Colors (falls back to default if not installed)
cat > "${LIVE_ROOT}/etc/xdg/lxqt/lxqt.conf" <<'EOF'
[General]
icon_theme=Breeze Dark
theme=Arch-Colors
EOF

# ----------------------------
# Wallpaper: use repository image
# ----------------------------
# Copy first supported image from /workspace/images to system backgrounds
wall=""
for n in background.png background.jpg wallpaper.png wallpaper.jpg trezor.png trezor.jpg; do
  if [ -f "${SRC_IMG_DIR}/${n}" ]; then
    wall="${n}"
    break
  fi
done
if [ -n "${wall}" ]; then
  install -m0644 "${SRC_IMG_DIR}/${wall}" "${LIVE_ROOT}/usr/share/backgrounds/trezor/${wall}"
  # pcmanfm-qt desktop wallpaper defaults (system-wide)
  install -d -m0755 "${LIVE_ROOT}/etc/xdg/pcmanfm-qt/lxqt"
  cat > "${LIVE_ROOT}/etc/xdg/pcmanfm-qt/lxqt/settings.conf" <<EOF
[Desktop]
wallpaper=/usr/share/backgrounds/trezor/${wall}
wallpaper_mode=stretch
show_wallpaper=true
EOF
fi

# ----------------------------
# Optional hardening: disable obvious network-y services that the spin may pull
# (We keep this conservative to avoid breaking the session; expand if you want fully offline.)
for s in NetworkManager-wait-online avahi-daemon cups ModemManager sshd ; do
  chroot "${LIVE_ROOT}" systemctl disable --now "$s" 2>/dev/null || true
  chroot "${LIVE_ROOT}" systemctl mask "$s" 2>/dev/null || true
done

%end
