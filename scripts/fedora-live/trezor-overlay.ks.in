%include __KSDIR__/fedora-live-workstation.ks

%packages
trezor-common
fuse-libs
curl
jq
sudo
ca-certificates
%end

# Copy pre-fetched bits from the workspace into the image and always create a launcher.
# No network needed here.
%post --nochroot --log=/root/trezor-post.log
set -euo pipefail

LIVE_ROOT="/mnt/sysimage"
SRC="/workspace/scripts/fedora-live/vendor"

# Ensure dirs
install -d -m0755 "${LIVE_ROOT}/opt/trezor"
install -d -m0755 "${LIVE_ROOT}/usr/share/applications"
install -d -m0755 "${LIVE_ROOT}/usr/local/bin"

# If host prefetch succeeded, copy artifacts in; otherwise, the launcher will self-fetch on first run.
if [ -f "${SRC}/trezor-suite.AppImage" ]; then
  install -m0755 "${SRC}/trezor-suite.AppImage" "${LIVE_ROOT}/opt/trezor/trezor-suite.AppImage"
fi
if [ -f "${SRC}/trezor-suite.AppImage.asc" ]; then
  install -m0644 "${SRC}/trezor-suite.AppImage.asc" "${LIVE_ROOT}/opt/trezor/trezor-suite.AppImage.asc"
fi
if [ -f "${SRC}/trezor.asc" ]; then
  install -m0644 "${SRC}/trezor.asc" "${LIVE_ROOT}/opt/trezor/trezor.asc"
fi

# First-run helper: if AppImage is missing, fetch latest from GitHub at launch.
cat > "${LIVE_ROOT}/usr/local/bin/trezor-suite" <<'EOS'
#!/usr/bin/env bash
set -euo pipefail
APP="/opt/trezor/trezor-suite.AppImage"
if [ ! -x "$APP" ]; then
  echo "Trezor Suite not found. Fetching latest AppImage..."
  TMP="$(mktemp -d)"
  URL="$(curl -fsSL https://api.github.com/repos/trezor/trezor-suite/releases/latest \
        | jq -r '.assets[] | select(.name|test("linux.*AppImage$")) | .browser_download_url' | head -n1)"
  if [ -z "$URL" ]; then
    echo "Could not determine latest AppImage URL from GitHub." >&2
    exit 1
  fi
  curl -fsSL -L "$URL" -o "$TMP/trezor.AppImage"
  chmod +x "$TMP/trezor.AppImage"
  sudo install -m0755 "$TMP/trezor.AppImage" "$APP"
fi
exec "$APP" --no-sandbox "$@"
EOS
chmod +x "${LIVE_ROOT}/usr/local/bin/trezor-suite"

# Desktop launcher (always created)
cat > "${LIVE_ROOT}/usr/share/applications/trezor-suite.desktop" <<'EOF'
[Desktop Entry]
Name=Trezor Suite
Comment=Manage your Trezor hardware wallet
Exec=/usr/local/bin/trezor-suite
Terminal=false
Type=Application
Categories=Finance;Utility;
EOF
%end
