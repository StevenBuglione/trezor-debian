# Base: official Workstation live KS (brings all live dracut bits)
%include __KSDIR__/fedora-live-workstation.ks

# Users / auth
rootpw --lock
firstboot --disable
selinux --enforcing
firewall --disabled

# Packages (add xrandr for Xorg path; rest as you had)
%packages
trezor-common
fuse-libs
curl
jq
sudo
ca-certificates
rsync
xrandr

# Optional removals to slim image
-gnome-boxes
-cheese
-rhythmbox
-totem
-simple-scan
-yelp
-gnome-tour
%end

# ----------------------------
# Stage Suite + desktop file + display prefs (no-chroot)
# ----------------------------
%post --nochroot --log=/root/trezor-post.log
set -euo pipefail

LIVE_ROOT="/mnt/sysimage"
SRC_VENDOR="/workspace/scripts/fedora-live/vendor"
SRC_IMG_DIR="/workspace/images"

install -d -m0755 \
  "${LIVE_ROOT}/opt/trezor" \
  "${LIVE_ROOT}/usr/share/applications" \
  "${LIVE_ROOT}/usr/share/icons/hicolor/scalable/apps" \
  "${LIVE_ROOT}/usr/local/bin" \
  "${LIVE_ROOT}/etc/xdg/autostart" \
  "${LIVE_ROOT}/etc/skel/.config" \
  "${LIVE_ROOT}/var/lib/gdm/.config" \
  "${LIVE_ROOT}/var/lib/gdm/seat0/config"

# --- Trezor Suite bits ---
[ -f "${SRC_VENDOR}/trezor-suite.AppImage" ] && \
  install -m0755 "${SRC_VENDOR}/trezor-suite.AppImage" \
    "${LIVE_ROOT}/opt/trezor/trezor-suite.AppImage" || true

[ -f "${SRC_IMG_DIR}/trezor-suite.png" ] && \
  install -m0644 "${SRC_IMG_DIR}/trezor-suite.png" \
    "${LIVE_ROOT}/usr/share/icons/hicolor/scalable/apps/trezor-suite.png" || true

cat > "${LIVE_ROOT}/usr/share/applications/trezor-suite.desktop" <<'EOF'
[Desktop Entry]
Name=Trezor Suite
Comment=Manage your Trezor hardware wallet
Exec=/opt/trezor/trezor-suite.AppImage --no-sandbox
Icon=trezor-suite
Terminal=false
Type=Application
Categories=Finance;Utility;
EOF

# --- Display configuration ---

# 1) Seed GNOME display layout for Wayland (and greeter):
cat > "${LIVE_ROOT}/etc/skel/.config/monitors.xml" <<'EOF'
<monitors version="2">
  <configuration>
    <logicalmonitor>
      <x>0</x>
      <y>0</y>
      <scale>1</scale>
      <primary>yes</primary>
      <transform>normal</transform>
      <monitor>
        <monitorspec>
          <connector>DP-1</connector>
        </monitorspec>
        <mode>
          <width>2560</width>
          <height>1440</height>
          <rate>60.0</rate>
        </mode>
      </monitor>
    </logicalmonitor>
  </configuration>
</monitors>
EOF

install -m0644 "${LIVE_ROOT}/etc/skel/.config/monitors.xml" \
  "${LIVE_ROOT}/var/lib/gdm/.config/monitors.xml"
install -m0644 "${LIVE_ROOT}/etc/skel/.config/monitors.xml" \
  "${LIVE_ROOT}/var/lib/gdm/seat0/config/monitors.xml"
chroot "${LIVE_ROOT}" bash -lc 'chown -R gdm:gdm /var/lib/gdm/.config /var/lib/gdm/seat0 || true'

# 2) Autostart helper for Xorg sessions (no-op on Wayland):
cat > "${LIVE_ROOT}/usr/local/bin/set-display.sh" <<'EOF'
#!/usr/bin/env bash
# Run only on Xorg; Wayland GNOME uses the seeded monitors.xml instead.
if [ "${XDG_SESSION_TYPE:-}" = "x11" ] || [ -n "${DISPLAY:-}" ]; then
  if command -v xrandr >/dev/null 2>&1; then
    if xrandr | grep -qE '(^|\s)DP-1(\s|$)'; then
      xrandr --output DP-1 --mode 2560x1440 --rate 60 --primary --rotate normal || true
    fi
  fi
fi
exit 0
EOF
chmod 0755 "${LIVE_ROOT}/usr/local/bin/set-display.sh"

cat > "${LIVE_ROOT}/etc/xdg/autostart/00-set-display.desktop" <<'EOF'
[Desktop Entry]
Type=Application
Name=Set Display Layout (DP-1 2560x1440)
Exec=/usr/local/bin/set-display.sh
OnlyShowIn=GNOME;
X-GNOME-Autostart-enabled=true
EOF

# 3) (Optional) If you want to force Xorg for deterministic xrandr, uncomment:
# cat > "${LIVE_ROOT}/etc/gdm/custom.conf" <<'EOF'
# [daemon]
# WaylandEnable=false
# DefaultSession=gnome-xorg.desktop
# EOF
# chroot "${LIVE_ROOT}" systemctl enable gdm || true
# chroot "${LIVE_ROOT}" systemctl set-default graphical.target || true

# Refresh icon cache if available
chroot "${LIVE_ROOT}" bash -lc 'command -v gtk-update-icon-cache >/dev/null 2>&1 && gtk-update-icon-cache -f /usr/share/icons/hicolor || true'

%end
